<html>
  <head>
    <link rel="stylesheet" href="js/leaflet/leaflet.css" />
     <script src="js/leaflet/leaflet.js"></script>     
     <script src="js/neo4j-1.6.2/neo4j-web.min.js"></script>
     <script src="js/jquery-3.3.1.slim.js"></script>

     <script src="js/heatcanvas/heatcanvas.js"></script>
     <script src="js/heatcanvas/heatcanvas-leaflet.js"></script>
     <script src="js/markercluster-1.3.0/leaflet.markercluster-src.js"></script>
     <link rel="stylesheet" href="js/markercluster-1.3.0/MarkerCluster.css" />
     <link rel="stylesheet" href="js/markercluster-1.3.0/MarkerCluster.Default.css" />

  <style>
    #map {height: 100%;}
  </style>

  </head>

  <body>
    <div id="map"></div>

    <script>
    var map;
    window.onload = function() {
      init();
    }   
    
    //text format function
    String.prototype.format = function() {
      var formatted = this;
      for (var i = 0; i < arguments.length; i++) {
          var regexp = new RegExp('\\{'+i+'\\}', 'gi');
          formatted = formatted.replace(regexp, arguments[i]);
      }
      return formatted;
    };
    

    idlinkformat = function(entities, entity_ids, entity_class, lat, lng){
      formatted_str = ''
      for (i = 0; i < entities.length; i++) {
        formatted_str += '<br><a href="#" class={0}Rel {0}ID={1} lat={2} lng={3}> {4} </a>'.format(entity_class, entity_ids[i], lat, lng, entities[i])
        }
      return formatted_str
    }

    function init() {
      console.log("init");
      //var driver = neo4j.v1.driver("bolt://165.227.223.190:7687", neo4j.v1.auth.basic("ppviz", "ppviz"));
      var driver = neo4j.v1.driver("bolt://localhost:7687", neo4j.v1.auth.basic("neo4j", "MYPASSWORD"));
      
      //var baseLayer = L.tileLayer('//{s}.tile.osm.org/{z}/{x}/{y}.png', { attribution: '<a target=_blank href="http://osm.org/copyright">OpenStreetMap</a> | Data From <a target=_blank href="https://offshoreleaks.icij.org/pages/database">ICIJ Offshore Leaks</a>', minZoom: 2, maxZoom: 18});
      var baseLayer = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png',{minZoom: 2, maxZoom: 18});
      var markerLayers = new L.MarkerClusterGroup();
      
      /*
      .run(`MATCH (a:Address)<-[:REGISTERED_ADDRESS]-(e:Entity)<-[:CONNECTED_TO|OFFICER_OF]-(o:Officer),
              (o)-[:CONNECTED_TO|OFFICER_OF]->(e2:Entity)-[:REGISTERED_ADDRESS]->(a2:Address)  
              WHERE e<>e2 and a.country_codes="MYS" and a2.country_codes="MYS" and exists(a2.latitude) and exists(a.latitude)
              WITH a, COLLECT(DISTINCT o)[0..5] AS officers, COLLECT(DISTINCT e)[0..5] AS entities, COLLECT(DISTINCT e2)[0..5] AS connected_entities, 
              COLLECT(DISTINCT a2)[0..5] AS connected_adds, COLLECT(DISTINCT e.jurisdiction_description)[0..5] AS jurisdictions, 1.0*COUNT(*) AS strength
              RETURN a.address AS address, a.latitude AS latitude, a.longitude AS longitude, [x IN officers | x.name] as officers, 
              [x IN connected_entities | x.name] as connected_entities, [x in connected_adds | [x.address, x.latitude, x.longitude]] as linked_coords, [x IN entities | x.name] as entities, jurisdictions, strength`)
        
      */
      var session = driver.session();
      session    
        .run(`MATCH (a:Address)<-[:REGISTERED_ADDRESS]-(e:Entity)<-[:CONNECTED_TO|OFFICER_OF]-(o:Officer)
              WHERE exists(a.latitude) and exists(a.longitude) 
              WITH a, COLLECT(DISTINCT o)[0..5] AS officers, COLLECT(DISTINCT e)[0..5] AS entities, 
              COLLECT(DISTINCT e.jurisdiction_description)[0..5] AS jurisdictions, 1.0*COUNT(*) AS strength
              RETURN a.address AS address, a.latitude AS latitude, a.longitude AS longitude, [x IN officers | x.name] as officers, [x in officers | x.node_id] as officer_ids,
              [x IN entities | x.name] as entities, [x IN entities | x.node_id] as entity_ids,  jurisdictions, strength`)
        .subscribe({
          onNext: function (record) {
            //console.log(record);
            var lat = record.get('latitude')
            var lng = record.get('longitude')
            var marker = new L.Marker(new L.LatLng(lat, lng))
            marker.bindPopup('<b>Address:</b> ' + record.get('address') + '<br>' + '<b>Officers: </b>' + record.get('officers').toString() 
            + '<br><b>Offshore Countries: </b> ' + record.get('jurisdictions').toString()
            + '<br><b>Entities:</b>' + idlinkformat(record.get('entities'), record.get('entity_ids'), 'entity', lat, lng)
            + '<br><b>Officers:</b>' + idlinkformat(record.get('officers'), record.get('officer_ids'), 'officer', lat, lng)
            );
        
            
            markerLayers.addLayer(marker);
            //heatmap.pushData(record.get('latitude'), record.get('longitude'), record.get('strength')*0.01);
          },
          onCompleted: function () {
        
            //var overlayMaps = {'Markers': markerLayers, 'Heatmap': heatmap};
            var overlayMaps = {'Markers': markerLayers};

            map = new L.Map('map', {center: new L.LatLng(51.505, -0.09), zoom: 3, layers: [baseLayer]});
            map.locate({setView: true, maxZoom: 7});
            



            map.on('popupopen', function() {
                $('.entityRel').click(function() {

                  e_id = $(this).attr('entityID')
                  e_coords = [parseFloat($(this).attr('lat')),parseFloat($(this).attr('lng'))];
                  session
                    .run(`MATCH (a:Address)<-[:REGISTERED_ADDRESS]-(e:Entity {node_id:"{0}"})<-[:CONNECTED_TO|OFFICER_OF]-(o:Officer),
                      (o)-[:CONNECTED_TO|OFFICER_OF]->(e2:Entity)-[:REGISTERED_ADDRESS]->(a2:Address)
                      WHERE  exists(a.latitude) and e<>e2 and a<>a2
                      RETURN DISTINCT a.address as address1, a2.address as address2, e.name as entity1, e2 as entity2, o as officer`.format(e_id))
                    .then(function (result) {
                      for (i = 0; i < result.records.length; i++) {
                          record = result.records[i]
                          //alert('Clicked the Link: ' + record.get('entity1').toString() + 'officer: '+ record.get('officer').toString() + 'address: '+ record.get('address2').toString()  );
                      }
                      console.log("RESULTS:")
                      console.log(result.records)
                      
                    }) 
                    console.log(e_id)
                    console.log(e_coords)
                });
                $('.officerRel').click(function(e) {
                    o_id = $(this).attr('officerID');
                    o_coords = [parseFloat($(this).attr('lat')),parseFloat($(this).attr('lng'))];
                    //console.log('Clicked the Link2: ' + o_ids );
                    session
                      .run(`MATCH (a:Address)<-[:REGISTERED_ADDRESS]-(e:Entity )<-[:CONNECTED_TO|OFFICER_OF]-(o:Officer  {node_id:"{0}"} ),
                      (o)-[:CONNECTED_TO|OFFICER_OF]->(e2:Entity)-[:REGISTERED_ADDRESS]->(a2:Address)
                      WHERE  exists(a.latitude) and e<>e2 and a<>a2
                      RETURN DISTINCT a.address as address1, a2.address as address2, e.name as entity1, e2 as entity2, o as officer`.format(o_id))
                      .then(function (result) {
                        for (i = 0; i < result.records.length; i++) {
                            record = result.records[i]
                            alert('Clicked the Link: ' + record.get('entity1').toString() + 'officer: '+ record.get('officer').toString() + 'address: '+ record.get('address2').toString()  );
                        }    
                      }) 
                  
                    
                    
                    /*
                    for (i = 0; i < o_ids.length; i++) {
                      oid = o_ids[i]
                      console.log('Clicked the Link2: ' + oid );
                    } 
                    console.log('latlng:' + o_coords);
                    
                    var pth1  = L.polyline([o_coords, [26, 80]]).addTo(map);
                    pth1.bindTooltip('<b>Address:</b> '  + '<br>' + '<b>Officers: </b>' +  '<br><b>Entities:</b> ' + '<br><b>Connected Entities:</b> ' + '<br><b>Connected Adds:</b> ').openTooltip();
                    */
                    /*
                    L.polyline([[45.51, -122.68],[26, 80]]).addTo(map)
                    L.polyline([[45.51, -122.68],[26, 20]]).addTo(map)
                    L.polyline([[45.51, -122.68],[6, 17]]).addTo(map)
                    L.polyline([[26, 20], [80, 100]]).addTo(map)
                    */
                  
                });



            });
            map.addLayer(markerLayers);
            //map.addLayer(heatmap);

            session.close();
          },
          onError: function (error) {
            console.log(error);
          }
        });
      }
    </script>
  </body>
  

</html>
